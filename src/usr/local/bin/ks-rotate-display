#!/bin/sh

# Reference https://askubuntu.com/a/405840/527080 for information about this

MODE=
P_SPECIFIER=left
L_SPECIFIER=bottom
VERBOSE=0
while [ "$#" -gt 0 ]; do
  case "$1" in
    --verbose) VERBOSE=1; shift;;
    portrait|landscape)
      if [ -z "$MODE" ]; then
        MODE="$1"
        shift
      else
        >&2 echo "E: Mode already set to '$MODE'. Can't pass mode twice.'"
        exit 1
      fi
    ;;
    top|bottom)
      if ! [ "$MODE" = "landscape" ]; then
        >&2 echo "E: Mode must be landscape in order to use 'top' or 'bottom' specifiers"
        exit 4
      else
        L_SPECIFIER="$1"
        shift
      fi
    ;;
    left|right)
      if ! [ "$MODE" = "portrait" ]; then
        >&2 echo "E: Mode must be portrait in order to use 'left' or 'right' specifiers"
        exit 5
      else
        P_SPECIFIER="$1"
        shift
      fi
    ;;
    *)
      >&2 echo "E: Unknown option '$1'"
      exit 2
    ;;
  esac
done

if [ -z "$MODE" ]; then
  >&2 echo "E: No mode provided. Mode should be either 'portrait' or 'landscape'"
  exit 3
fi

if [ "$MODE" = "portrait" ]; then
  rotation="$P_SPECIFIER"
  coords="0 -1 1 1 0 0 0 0 1"
else
  rotation="$([ "$L_SPECIFIER" = "bottom" ] && echo "normal" || echo "inverted")"
  coords="0 0 0 0 0 0 0 0 0"
fi

# Get devices to adjust
DEVICES="$(xinput -list | grep -i wacom | sed -r 's/^.*(wacom[^\t]+).*$/\1/i')"
if [ "$(echo -n "$DEVICES" | wc -l)" -eq 0 ]; then
    >&2 echo "No Wacom devices found on this machine. Don't know what to do. Exiting."
    exit 1
elif [ "$VERBOSE" -eq 1 ]; then
    >&2 echo "Found $(echo "$DEVICES" | wc -l) Wacom devices"
fi

[ "$VERBOSE" -eq 1 ] && >&2 echo "Rotating display to $rotation"
xrandr -o "$rotation"
echo "$DEVICES" | while read D; do
    >&2 echo "Resetting coordinates for device '$D'"
    xinput set-prop "$D" --type=float "Coordinate Transformation Matrix" $coords
done

